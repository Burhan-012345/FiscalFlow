{% extends "base.html" %} {% block title %}Reports - FiscalFlow{% endblock %} {%
block extra_css %}
<style>
  .report-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    border-radius: 12px;
  }
  .report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 102, 255, 0.15);
  }
  .report-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  .report-option {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .report-option:hover {
    border-color: var(--primary-blue);
    background-color: var(--light-blue);
  }
  .report-option.selected {
    border-color: var(--primary-blue);
    background-color: var(--light-blue);
  }
  .date-range-picker {
    background: var(--light-blue);
    border-radius: 8px;
    padding: 20px;
  }
  .download-buttons {
    margin-top: 20px;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col">
      <h1 class="h2 fw-bold">Reports & Analytics</h1>
      <p class="text-muted">
        Generate detailed reports and analyze your financial data
      </p>
    </div>
    <div class="col-auto">
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" id="quickReportBtn">
          <i class="fas fa-bolt me-2"></i>Quick Report
        </button>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#customReportModal"
        >
          <i class="fas fa-cog me-2"></i>Custom Report
        </button>
      </div>
    </div>
  </div>

  <!-- Report Cards -->
  <div class="row mb-5">
    <div class="col-md-3">
      <div class="card report-card h-100">
        <div class="card-body text-center">
          <div class="report-icon bg-primary text-white mx-auto mb-3">
            <i class="fas fa-file-pdf"></i>
          </div>
          <h5>PDF Reports</h5>
          <p class="text-muted small">
            Professional PDF documents with charts and summaries
          </p>
          <button
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#pdfReportModal"
          >
            Generate PDF
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card report-card h-100">
        <div class="card-body text-center">
          <div class="report-icon bg-success text-white mx-auto mb-3">
            <i class="fas fa-file-excel"></i>
          </div>
          <h5>Excel Reports</h5>
          <p class="text-muted small">
            Spreadsheet files for data analysis and accounting
          </p>
          <button
            class="btn btn-outline-success btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#excelReportModal"
          >
            Export Excel
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card report-card h-100">
        <div class="card-body text-center">
          <div class="report-icon bg-info text-white mx-auto mb-3">
            <i class="fas fa-chart-bar"></i>
          </div>
          <h5>Analytics</h5>
          <p class="text-muted small">
            Interactive charts and business insights
          </p>
          <a href="#analyticsSection" class="btn btn-outline-info btn-sm">
            View Analytics
          </a>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card report-card h-100">
        <div class="card-body text-center">
          <div class="report-icon bg-warning text-white mx-auto mb-3">
            <i class="fas fa-history"></i>
          </div>
          <h5>Audit Logs</h5>
          <p class="text-muted small">
            Complete activity history and change tracking
          </p>
          <button
            class="btn btn-outline-warning btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#auditReportModal"
          >
            View Logs
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-tachometer-alt me-2"></i>Quick Statistics
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-2">
              <h3 class="text-primary fw-bold">
                ₹{{ "%.2f"|format(total_balance) }}
              </h3>
              <small class="text-muted">Total Balance</small>
            </div>
            <div class="col-md-2">
              <h3 class="text-success fw-bold">
                ₹{{ "%.2f"|format(total_revenue) }}
              </h3>
              <small class="text-muted">Total Revenue</small>
            </div>
            <div class="col-md-2">
              <h3 class="text-danger fw-bold">
                ₹{{ "%.2f"|format(total_expenses) }}
              </h3>
              <small class="text-muted">Total Expenses</small>
            </div>
            <div class="col-md-2">
              <h3 class="text-info fw-bold">{{ customer_count }}</h3>
              <small class="text-muted">Active Customers</small>
            </div>
            <div class="col-md-2">
              <h3 class="text-warning fw-bold">{{ transaction_count }}</h3>
              <small class="text-muted">Total Transactions</small>
            </div>
            <div class="col-md-2">
              <h3 class="text-secondary fw-bold">{{ active_accounts }}</h3>
              <small class="text-muted">Active Accounts</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Reports Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>Customer Reports
          </h5>
        </div>
        <div class="card-body">
          {% if customers %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Customer Name</th>
                  <th>Email</th>
                  <th>Current Balance</th>
                  <th>Transactions</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for customer in customers %}
                <tr>
                  <td>
                    <i class="fas fa-user-circle me-2 text-primary"></i>
                    {{ customer.name }}
                  </td>
                  <td>{{ customer.email or 'N/A' }}</td>
                  <td>
                    <span
                      class="fw-bold {% if customer.current_balance >= 0 %}text-success{% else %}text-danger{% endif %}"
                    >
                      ₹{{ "%.2f"|format(customer.current_balance) }}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-secondary"
                      >{{ customer.transactions|length }}</span
                    >
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a
                        href="{{ url_for('generate_pdf_report', customer_id=customer.id) }}"
                        class="btn btn-danger"
                        target="_blank"
                      >
                        <i class="fas fa-file-pdf me-1"></i>PDF
                      </a>
                      <a
                        href="{{ url_for('generate_excel_report', customer_id=customer.id) }}"
                        class="btn btn-success"
                        target="_blank"
                      >
                        <i class="fas fa-file-excel me-1"></i>Excel
                      </a>
                      <a
                        href="{{ url_for('customer_detail', customer_id=customer.id) }}"
                        class="btn btn-primary"
                      >
                        <i class="fas fa-eye me-1"></i>View
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Customers Found</h5>
            <p class="text-muted">Add customers to generate reports</p>
            <a href="{{ url_for('add_account') }}" class="btn btn-primary">
              <i class="fas fa-plus me-2"></i>Add Your First Customer
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="row" id="analyticsSection">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>Financial Trends
          </h5>
          <select
            class="form-select form-select-sm"
            style="width: auto"
            id="timeRangeSelect"
          >
            <option value="7d">Last 7 Days</option>
            <option value="30d" selected>Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="1y">Last Year</option>
          </select>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="financialTrendsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie me-2"></i>Customer Distribution
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="customerDistributionChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Reports -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>Recently Generated Reports
          </h5>
          <button class="btn btn-sm btn-outline-primary" id="refreshReports">
            <i class="fas fa-sync-alt me-1"></i>Refresh
          </button>
        </div>
        <div class="card-body">
          {% if recent_reports %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Report Name</th>
                  <th>Type</th>
                  <th>Generated On</th>
                  <th>Size</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for report in recent_reports %}
                <tr>
                  <td>
                    <i
                      class="fas {% if report.type == 'pdf' %}fa-file-pdf text-danger{% else %}fa-file-excel text-success{% endif %} me-2"
                    ></i>
                    {{ report.name }}
                  </td>
                  <td>
                    <span
                      class="badge {% if report.type == 'pdf' %}bg-danger{% else %}bg-success{% endif %}"
                    >
                      {{ report.type|upper }}
                    </span>
                  </td>
                  <td>{{ report.generated_on }}</td>
                  <td>{{ report.size }}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a
                        href="{{ report.download_url }}"
                        class="btn btn-outline-primary"
                      >
                        <i class="fas fa-download"></i>
                      </a>
                      <button class="btn btn-outline-secondary">
                        <i class="fas fa-share"></i>
                      </button>
                      <button class="btn btn-outline-danger">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Reports Generated Yet</h5>
            <p class="text-muted">Generate your first report to see it here</p>
            <div class="download-buttons">
              <a
                href="{{ url_for('generate_pdf_report', customer_id=customers[0].id) if customers else '#' }}"
                class="btn btn-danger {% if not customers %}disabled{% endif %}"
                target="_blank"
              >
                <i class="fas fa-file-pdf me-2"></i>Generate Sample PDF
              </a>
              <a
                href="{{ url_for('generate_excel_report', customer_id=customers[0].id) if customers else '#' }}"
                class="btn btn-success {% if not customers %}disabled{% endif %}"
                target="_blank"
              >
                <i class="fas fa-file-excel me-2"></i>Generate Sample Excel
              </a>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PDF Report Modal -->
<div class="modal fade" id="pdfReportModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-file-pdf me-2 text-danger"></i>Generate PDF Report
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="pdfReportForm">
          <div class="mb-3">
            <label class="form-label">Report Type</label>
            <div>
              <div class="report-option selected" data-type="customer">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="reportType"
                    id="customerReport"
                    value="customer"
                    checked
                  />
                  <label class="form-check-label fw-bold" for="customerReport">
                    Customer Statement
                  </label>
                </div>
                <small class="text-muted"
                  >Detailed transaction history for specific customers</small
                >
              </div>
              <div class="report-option" data-type="summary">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="reportType"
                    id="summaryReport"
                    value="summary"
                  />
                  <label class="form-check-label fw-bold" for="summaryReport">
                    Financial Summary
                  </label>
                </div>
                <small class="text-muted"
                  >Overview of all accounts and transactions</small
                >
              </div>
              <div class="report-option" data-type="analytics">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="reportType"
                    id="analyticsReport"
                    value="analytics"
                  />
                  <label class="form-check-label fw-bold" for="analyticsReport">
                    Analytics Report
                  </label>
                </div>
                <small class="text-muted">Charts and business insights</small>
              </div>
            </div>
          </div>

          <div class="date-range-picker mb-4">
            <label class="form-label fw-bold">Date Range</label>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" id="fromDate" />
              </div>
              <div class="col-md-6">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" id="toDate" />
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Customers</label>
            <select class="form-select" multiple id="customerSelect">
              <option value="all" selected>All Customers</option>
              {% for customer in customers %}
              <option value="{{ customer.id }}">{{ customer.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Hold Ctrl/Cmd to select multiple customers
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Include in Report</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="includeCharts"
                checked
              />
              <label class="form-check-label" for="includeCharts"
                >Charts and Graphs</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="includeSummary"
                checked
              />
              <label class="form-check-label" for="includeSummary"
                >Executive Summary</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="includeTransactions"
                checked
              />
              <label class="form-check-label" for="includeTransactions"
                >Detailed Transactions</label
              >
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="generatePdf">
          <i class="fas fa-file-pdf me-2"></i>Generate PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Excel Report Modal -->
<div class="modal fade" id="excelReportModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-file-excel me-2 text-success"></i>Export Excel Report
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="excelReportForm">
          <div class="mb-3">
            <label class="form-label">Export Type</label>
            <select class="form-select" id="excelExportType">
              <option value="transactions">Transaction History</option>
              <option value="customers">Customer List</option>
              <option value="balance">Balance Summary</option>
              <option value="all">Complete Data Export</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Date Range</label>
            <div class="row">
              <div class="col-md-6">
                <input type="date" class="form-control" id="excelFromDate" />
              </div>
              <div class="col-md-6">
                <input type="date" class="form-control" id="excelToDate" />
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Format Options</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="includeFormulas"
                checked
              />
              <label class="form-check-label" for="includeFormulas"
                >Include Formulas</label
              >
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="includeChartsExcel"
              />
              <label class="form-check-label" for="includeChartsExcel"
                >Include Charts</label
              >
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" id="generateExcel">
          <i class="fas fa-file-excel me-2"></i>Export Excel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Report option selection
    const reportOptions = document.querySelectorAll(".report-option");
    reportOptions.forEach((option) => {
      option.addEventListener("click", function () {
        reportOptions.forEach((opt) => opt.classList.remove("selected"));
        this.classList.add("selected");
        const radio = this.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
      });
    });

    // Set default dates
    const today = new Date().toISOString().split("T")[0];
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split("T")[0];

    document.getElementById("fromDate").value = thirtyDaysAgoStr;
    document.getElementById("toDate").value = today;
    document.getElementById("excelFromDate").value = thirtyDaysAgoStr;
    document.getElementById("excelToDate").value = today;

    // Generate PDF
    document.getElementById("generatePdf").addEventListener("click", function () {
      const reportType = document.querySelector('input[name="reportType"]:checked').value;
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const selectedCustomers = Array.from(document.getElementById("customerSelect").selectedOptions).map(opt => opt.value);

      showNotification("Generating PDF report...", "info");

      // Simple implementation - generate for first selected customer or first available customer
      let customerId = null;

      if (selectedCustomers.includes('all') && {{ customers|length if customers else 0 }} > 0) {
        // Use first customer if "all" is selected
        customerId = {{ customers[0].id if customers else 'null' }};
      } else if (selectedCustomers.length > 0 && selectedCustomers[0] !== 'all') {
        // Use first selected customer
        customerId = selectedCustomers[0];
      }

      if (customerId) {
        // Redirect to PDF generation endpoint
        window.open(`/customer/${customerId}/report/pdf?from_date=${fromDate}&to_date=${toDate}`, '_blank');
        setTimeout(() => {
          showNotification("PDF report generated successfully!", "success");
          $("#pdfReportModal").modal("hide");
        }, 2000);
      } else {
        showNotification("Please select at least one customer", "warning");
      }
    });

    // Generate Excel
    document.getElementById("generateExcel").addEventListener("click", function () {
      const exportType = document.getElementById("excelExportType").value;
      const fromDate = document.getElementById("excelFromDate").value;
      const toDate = document.getElementById("excelToDate").value;

      showNotification("Exporting Excel report...", "info");

      // Simple implementation - generate for first available customer
      const firstCustomerId = {{ customers[0].id if customers else 'null' }};
      if (firstCustomerId) {
        window.open(`/customer/${firstCustomerId}/report/excel?export_type=${exportType}&from_date=${fromDate}&to_date=${toDate}`, '_blank');
        setTimeout(() => {
          showNotification("Excel report exported successfully!", "success");
          $("#excelReportModal").modal("hide");
        }, 2000);
      } else {
        showNotification("No customers available for export", "warning");
      }
    });

    // Quick report
    document.getElementById("quickReportBtn").addEventListener("click", function () {
      showNotification("Generating quick report...", "info");

      const firstCustomerId = {{ customers[0].id if customers else 'null' }};
      if (firstCustomerId) {
        window.open(`/customer/${firstCustomerId}/report/pdf`, '_blank');
        setTimeout(() => {
          showNotification("Quick report ready for download!", "success");
        }, 1500);
      } else {
        showNotification("No customers available for report generation", "warning");
      }
    });

    // Initialize charts (if available)
    if (typeof FiscalFlowCharts !== "undefined") {
      // Sample data for demonstration
      const trendsData = {
        labels: ["Week 1", "Week 2", "Week 3", "Week 4"],
        revenue: [12000, 15000, 18000, 22000],
        expenses: [8000, 9000, 11000, 13000],
        balance: [4000, 6000, 7000, 9000],
      };

      const distributionData = {
        labels: ["Retail", "Corporate", "Individual", "Wholesale"],
        values: [35, 25, 20, 20],
      };

      FiscalFlowCharts.initRevenueExpenseChart(
        "financialTrendsChart",
        trendsData
      );
      FiscalFlowCharts.initCustomerDistributionChart(
        "customerDistributionChart",
        distributionData
      );
    }
  });

  // Helper function for notifications
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 3000);
  }
</script>
{% endblock %}
